<!-- index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gymkana Jujutsu Kaisen - Registro</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="background">
  <h1>Gymkana Jujutsu Kaisen - Registro</h1>
  <form id="loginForm" class="login-form">
    <input type="text" id="name" placeholder="Nombre" required />
    <input type="password" id="password" placeholder="Contraseña" required />
    <button type="submit">Entrar</button>
  </form>
  <script src="script.js"></script>
</body>
</html>

<!-- scan.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escanear QR</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="background">
  <h1>Escaneo de QR</h1>
  <div id="scanStatus"></div>
  <a href="ranking.html">Ver Ranking</a>
  <script src="script.js"></script>
  <script>
    if (!getCurrentUser()) {
      alert("Debes estar registrado para escanear códigos QR.");
      window.location.href = 'index.html';
    } else {
      handleQRScan();
    }
  </script>
</body>
</html>

<!-- ranking.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking - Gymkana Jujutsu Kaisen</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="background">
  <h1>Ranking en Tiempo Real</h1>
  <div id="ranking"></div>
  <script src="script.js"></script>
  <script>
    renderRanking();
  </script>
</body>
</html>

<!-- style.css -->
body.background {
  background: url("background.jpg") no-repeat center center fixed;
  background-size: cover;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: white;
  text-align: center;
}

h1 {
  margin-top: 1.5em;
  text-shadow: 0 0 10px black;
}

.login-form {
  background: rgba(0, 0, 0, 0.75);
  border-radius: 10px;
  padding: 2em;
  width: 300px;
  margin: 2em auto;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
}

input, button {
  display: block;
  margin: 1em auto;
  padding: 0.75em;
  width: 90%;
  border: none;
  border-radius: 5px;
}

input {
  background: #333;
  color: white;
}

button {
  background: #2196f3;
  color: white;
  cursor: pointer;
  transition: background 0.3s;
}

button:hover {
  background: #0b7dda;
}

/* script.js */
const EVENT_START = new Date('2025-05-25T16:00:00');
const EVENT_END = new Date('2025-05-25T17:30:00');

const QR_HASHES = {
  "62af2": 1,
  "a49d3": 2,
  "c7f84": 3,
  "34e0b": 4,
  "5a8d9": 5,
  "9b13c": 6,
  "e23aa": 7,
  "b6d4e": 8,
  "712ac": 9,
  "3ecf2": 10,
  "fde77": 11,
  "4b91a": 12,
  "886dd": 13,
  "7a993": 14,
  "2c1e8": 15,
  "1f3cb": 16,
  "d99f0": 17,
  "ebac3": 18,
  "a6d72": 19,
  "05cde": 20
};

function getUsers() {
  return JSON.parse(localStorage.getItem('users') || '{}');
}

function saveUsers(users) {
  localStorage.setItem('users', JSON.stringify(users));
}

function getCurrentUser() {
  return localStorage.getItem('currentUser');
}

function setCurrentUser(name) {
  localStorage.setItem('currentUser', name);
}

function handleLogin() {
  const form = document.getElementById('loginForm');
  form?.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const password = document.getElementById('password').value;
    if (!name || !password) return alert('Introduce nombre y contraseña');
    const users = getUsers();
    if (users[name] && users[name].password !== password) {
      alert('Contraseña incorrecta');
      return;
    }
    if (!users[name]) {
      users[name] = { password, scans: [] };
      saveUsers(users);
    }
    setCurrentUser(name);
    window.location.href = 'scan.html';
  });
}

function handleQRScan() {
  const params = new URLSearchParams(window.location.search);
  const hash = params.get('qr');
  const qrId = QR_HASHES[hash];
  const now = new Date();
  const scanStatus = document.getElementById('scanStatus');

  if (!qrId) {
    scanStatus.textContent = 'QR no válido';
    return;
  }
  if (now < EVENT_START) {
    scanStatus.textContent = 'La gymkana aún no ha comenzado.';
    return;
  }
  if (now > EVENT_END) {
    scanStatus.textContent = 'La gymkana ha terminado.';
    return;
  }
  const user = getCurrentUser();
  if (!user) {
    scanStatus.textContent = 'No estás identificado.';
    return;
  }
  const users = getUsers();
  const userData = users[user];
  if (userData.scans.find((s) => s.qr == qrId)) {
    scanStatus.textContent = `Ya habías escaneado este código.`;
    return;
  }
  userData.scans.push({ qr: qrId, time: now.toISOString() });
  saveUsers(users);
  scanStatus.textContent = `Escaneo registrado del código ${qrId}`;
}

function renderRanking() {
  const users = getUsers();
  const sorted = Object.entries(users).map(([name, data]) => {
    return {
      name,
      count: data.scans.length,
      lastScan: data.scans.reduce((latest, s) =>
        !latest || new Date(s.time) > new Date(latest.time) ? s : latest, null)
    };
  }).sort((a, b) => {
    if (b.count !== a.count) return b.count - a.count;
    return new Date(a.lastScan?.time || 0) - new Date(b.lastScan?.time || 0);
  });

  const rankingDiv = document.getElementById('ranking');
  rankingDiv.innerHTML = '<ol>' +
    sorted.map(user => `<li>${user.name} - ${user.count} códigos</li>`).join('') +
    '</ol>';
}

handleLogin();
